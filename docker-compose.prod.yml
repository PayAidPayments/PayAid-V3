version: '3.8'

services:
  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: payaid-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - app
    restart: unless-stopped
    networks:
      - payaid-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Next.js Application
  app:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: payaid-app
    environment:
      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-payaid}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-payaid_v3}?schema=public
      
      # Redis
      - REDIS_URL=redis://redis:6379
      
      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-24h}
      
      # NextAuth
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      
      # App Configuration
      - NODE_ENV=production
      - APP_URL=${APP_URL:-http://localhost:3000}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      - NEXT_PUBLIC_SUBDOMAIN_DOMAIN=${NEXT_PUBLIC_SUBDOMAIN_DOMAIN:-payaid.com}
      
      # Encryption
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # AI Services
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.1:8b}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GROQ_MODEL=${GROQ_MODEL:-llama-3.1-8b-instant}
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - HUGGINGFACE_MODEL=${HUGGINGFACE_MODEL:-google/gemma-2-2b-it}
      - HUGGINGFACE_IMAGE_MODEL=${HUGGINGFACE_IMAGE_MODEL:-ByteDance/SDXL-Lightning}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      
      # Email
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - SENDGRID_FROM_EMAIL=${SENDGRID_FROM_EMAIL:-noreply@payaid.com}
      
      # SMS
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
      - EXOTEL_API_KEY=${EXOTEL_API_KEY}
      - EXOTEL_API_TOKEN=${EXOTEL_API_TOKEN}
      - EXOTEL_SID=${EXOTEL_SID}
      
      # WhatsApp
      - WATI_API_KEY=${WATI_API_KEY}
      - WATI_BASE_URL=${WATI_BASE_URL:-https://api.wati.io}
      
      # PayAid Payments
      - PAYAID_ADMIN_API_KEY=${PAYAID_ADMIN_API_KEY}
      - PAYAID_ADMIN_SALT=${PAYAID_ADMIN_SALT}
      - PAYAID_PAYMENTS_PG_API_URL=${PAYAID_PAYMENTS_PG_API_URL}
      - PAYAID_PAYMENTS_BASE_URL=${PAYAID_PAYMENTS_BASE_URL}
      
      # File Storage (Cloudflare R2 or MinIO)
      - CLOUDFLARE_R2_ACCOUNT_ID=${CLOUDFLARE_R2_ACCOUNT_ID}
      - CLOUDFLARE_R2_ACCESS_KEY_ID=${CLOUDFLARE_R2_ACCESS_KEY_ID}
      - CLOUDFLARE_R2_SECRET_ACCESS_KEY=${CLOUDFLARE_R2_SECRET_ACCESS_KEY}
      - CLOUDFLARE_R2_BUCKET_NAME=${CLOUDFLARE_R2_BUCKET_NAME}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME:-payaid-files}
      
      # Upstash Redis (if using for rate limiting)
      - UPSTASH_REDIS_REST_URL=${UPSTASH_REDIS_REST_URL}
      - UPSTASH_REDIS_REST_TOKEN=${UPSTASH_REDIS_REST_TOKEN}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      ollama:
        condition: service_started
    restart: unless-stopped
    networks:
      - payaid-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: payaid-postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-payaid}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-payaid_v3}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped
    networks:
      - payaid-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-payaid}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Caching and Rate Limiting
  redis:
    image: redis:7-alpine
    container_name: payaid-redis
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - payaid-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Ollama AI Service
  ollama:
    image: ollama/ollama:latest
    container_name: payaid-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
      - OLLAMA_NUM_GPU=${OLLAMA_NUM_GPU:-0}
      - OLLAMA_NUM_PARALLEL=${OLLAMA_NUM_PARALLEL:-1}
    deploy:
      resources:
        limits:
          memory: ${OLLAMA_MEMORY_LIMIT:-2.8G}
          cpus: ${OLLAMA_CPU_LIMIT:-1.5}
        reservations:
          memory: ${OLLAMA_MEMORY_RESERVATION:-1.5G}
    restart: unless-stopped
    networks:
      - payaid-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # MinIO for File Storage (Optional - use Cloudflare R2 if preferred)
  minio:
    image: minio/minio:latest
    container_name: payaid-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    restart: unless-stopped
    networks:
      - payaid-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backup Service (runs daily at 2 AM)
  backup:
    image: postgres:15-alpine
    container_name: payaid-backup
    environment:
      - PGPASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=${POSTGRES_USER:-payaid}
      - POSTGRES_DB=${POSTGRES_DB:-payaid_v3}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-30}
    volumes:
      - backup-data:/backups
      - ./scripts/backup-database.sh:/backup.sh:ro
    command: /bin/sh -c "chmod +x /backup.sh && apk add --no-cache curl && sh /backup.sh"
    depends_on:
      - postgres
    restart: "no"  # Manual or cron-based
    networks:
      - payaid-network
    profiles:
      - backup  # Only start with --profile backup

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  ollama-data:
    driver: local
  minio-data:
    driver: local
  backup-data:
    driver: local
  nginx-logs:
    driver: local

networks:
  payaid-network:
    driver: bridge
