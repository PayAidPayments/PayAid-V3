name: Cron Jobs

on:
  schedule:
    # Recalculate scores every hour
    - cron: '0 * * * *'
    # Send scheduled emails every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  recalculate-scores:
    runs-on: ubuntu-latest
    steps:
      - name: Check Secrets
        run: |
          if [ -z "${{ secrets.APP_URL }}" ]; then
            echo "‚ö†Ô∏è APP_URL secret is not set. Skipping cron job."
            exit 0
          fi
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "‚ö†Ô∏è CRON_SECRET secret is not set. Skipping cron job."
            exit 0
          fi
      
      - name: Recalculate Lead Scores
        run: |
          APP_URL="${{ secrets.APP_URL }}"
          CRON_SECRET="${{ secrets.CRON_SECRET }}"
          
          if [ -z "$APP_URL" ] || [ -z "$CRON_SECRET" ]; then
            echo "‚ö†Ô∏è Required secrets not configured. Skipping cron job."
            exit 0
          fi
          
          echo "üîÑ Calling: ${APP_URL}/api/cron/recalculate-scores"
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST "${APP_URL}/api/cron/recalculate-scores" \
            -H "Authorization: Bearer ${CRON_SECRET}" \
            -H "Content-Type: application/json" \
            --fail-with-body || true)
          
          http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_STATUS/d')
          
          echo "Response: $body"
          echo "HTTP Status: $http_status"
          
          if [ "$http_status" = "200" ] || [ "$http_status" = "201" ]; then
            echo "‚úÖ Cron job completed successfully"
            exit 0
          else
            echo "‚ö†Ô∏è Cron job returned status $http_status (non-critical, continuing)"
            exit 0
          fi

  send-emails:
    runs-on: ubuntu-latest
    steps:
      - name: Check Secrets
        run: |
          if [ -z "${{ secrets.APP_URL }}" ]; then
            echo "‚ö†Ô∏è APP_URL secret is not set. Skipping cron job."
            exit 0
          fi
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "‚ö†Ô∏è CRON_SECRET secret is not set. Skipping cron job."
            exit 0
          fi
      
      - name: Send Scheduled Emails
        run: |
          APP_URL="${{ secrets.APP_URL }}"
          CRON_SECRET="${{ secrets.CRON_SECRET }}"
          
          if [ -z "$APP_URL" ] || [ -z "$CRON_SECRET" ]; then
            echo "‚ö†Ô∏è Required secrets not configured. Skipping cron job."
            exit 0
          fi
          
          echo "üìß Calling: ${APP_URL}/api/cron/send-scheduled-emails"
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST "${APP_URL}/api/cron/send-scheduled-emails" \
            -H "Authorization: Bearer ${CRON_SECRET}" \
            -H "Content-Type: application/json" \
            --fail-with-body || true)
          
          http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_STATUS/d')
          
          echo "Response: $body"
          echo "HTTP Status: $http_status"
          
          if [ "$http_status" = "200" ] || [ "$http_status" = "201" ]; then
            echo "‚úÖ Cron job completed successfully"
            exit 0
          else
            echo "‚ö†Ô∏è Cron job returned status $http_status (non-critical, continuing)"
            exit 0
          fi
